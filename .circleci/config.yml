version: 2.1
jobs:
  dependencies:
    docker:
      - image: cryptogarageinc/p2pderivatives-client-ci
    steps:
      - checkout
      - run:
          name: Checkout submodules
          command: |
            git submodule update --init --recursive
            git ls-tree HEAD p2pderivatives-proto | awk '{ print $3 }' > p2pd-proto-hash.txt

      - restore_cache:
          keys:
            ## add vX-debug suffix when debugging cache
            - npm-deps-{{ .Branch }}-{{ checksum "package-lock.json" }}-v1
      - run:
          name: Install nodes modules
          command: |
            if [ -d "node_modules" ]; then
              export HAS_NPM_CACHE="true"
            fi
            npm run-script preci && (cd gen-grpc && npm run-script preci)
            if [ -z "$HAS_NPM_CACHE" ]; then
              npm ci
            fi
      - save_cache:
          key: npm-deps-{{ .Branch }}-{{ checksum "package-lock.json" }}-v1
          paths:
            - node_modules

      - restore_cache:
          keys:
            - gen-grpc-deps-{{checksum "p2pd-proto-hash.txt"}}-v1
      - run:
          name: Generate gen grpc
          command: |
            if ls gen-grpc/*.proto >/dev/null 2>&1; then
              export HAS_GEN_GRPC_CACHE="true"
            fi
            if [ -z "$HAS_GEN_GRPC_CACHE" ]; then
              cd gen-grpc && npm run-script gen
            fi
      - save_cache:
          key: gen-grpc-deps-{{checksum "p2pd-proto-hash.txt"}}-v1
          paths:
            - gen-grpc

      - persist_to_workspace:
          root: .
          paths:
            - .

  lint:
    docker:
      - image: cryptogarageinc/p2pderivatives-client-ci
    steps:
      - attach_workspace:
          at: .
      - run: npm run lint:ci
      - store_test_results:
          path: ./reports/linter
      - store_artifacts:
          path: ./reports/linter

  build:
    docker:
      - image: cryptogarageinc/p2pderivatives-client-ci
    steps:
      - attach_workspace:
          at: .
      - run:
          name: build
          command: CI=false npm run build # ci to false avoid linter warnings as errors

  jest-tests:
    docker:
      - image: cryptogarageinc/p2pderivatives-client-ci
    steps:
      - attach_workspace:
          at: .
      - run:
          name: ReBuild grpc for node
          command: npm rebuild grpc --runtime=node
      - run:
          name: run jest test
          command: npm run test:ci
      - store_test_results:
          path: ./reports/jest
      - store_artifacts:
          path: ./reports/jest

  mocha-tests:
    docker:
      - image: cryptogarageinc/p2pderivatives-client-ci:latest-browser
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Rebuild grpc for electron
          command: npm rebuild grpc --runtime=electron --target=7.0.0
      - run:
          name: Run mocha test
          command: npm run mocha:ci
      - store_test_results:
          path: ./reports/mocha
      - store_artifacts:
          path: ./reports/mocha

workflows:
  lint-build-test:
    jobs:
      - dependencies
      - lint:
          requires:
            - dependencies
      - build:
          requires:
            - dependencies
      - jest-tests:
          requires:
            - build
      - mocha-tests:
          requires:
            - build
